#!/usr/bin/env python3

import argparse

from default_utils import FileNotOpened, TextNotFound, WindowedFile  # type: ignore

parser = argparse.ArgumentParser()
parser.add_argument("search", type=str)
parser.add_argument("replace", type=str)
parser.add_argument("--replace-all", action="store_true")
args = parser.parse_args()


_NOT_FOUND_IN_WINDOW_MSG = f"""Text {args.search!r} not found in displayed lines.
Note: By default, we only replace the first occurrence in the lines that are currently visible in the editor.
If you want to replace all occurrences in and outside of the visible lines, use the `--replace-all` flag.
"""

_NO_CHANGES_MADE_MSG = """Your search and replace strings are the same. No changes were made."""

try:
    wf = WindowedFile(exit_on_exception=False)
except FileNotOpened:
    print("No file opened. Either `open` a file first.")
    exit(1)

# Turn \\n into \n etc., i.e., undo the escaping
# args.replace = args.replace.encode("utf8").decode("unicode_escape")

if args.search == args.replace:
    print(_NO_CHANGES_MADE_MSG)
    exit(2)

if not args.replace_all:
    try:
        wf.replace_in_window(args.search, args.replace, n_replacements=1)
    except TextNotFound:
        print(_NOT_FOUND_IN_WINDOW_MSG)
        exit(3)
else:
    # todo: Give overview of all replaced occurrences
    wf.replace(args.search, args.replace)

wf.print_window()
