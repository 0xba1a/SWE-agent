#!/usr/bin/env python3

import argparse

from default_utils import FileNotOpened, WindowedFile  # type: ignore

parser = argparse.ArgumentParser()
parser.add_argument("search", type=str)
parser.add_argument("replace", type=str)
parser.add_argument("--replace-all", action="store_true")
args = parser.parse_args()


try:
    current_file = WindowedFile()
except FileNotOpened:
    print("No file opened. Either `open` a file first.")
    exit(1)

# Turn \\n into \n etc., i.e., undo the escaping
args.replace = args.replace.encode("utf8").decode("unicode_escape")
if not args.replace_all:
    text_in_window = current_file.get_window_text()
    new_text_in_window = text_in_window.replace(args.search, args.replace, 1)
    if text_in_window == new_text_in_window:
        print(
            "No changes made. Please make sure that your search and replace strings are correct. "
            "Note: By default, we only replace the first occurrence in the lines that are currently visible in the editor. "
            "If you want to replace all occurrences, use the `--replace-all` flag."
        )
        exit(0)
    current_file.set_window_text(new_text_in_window)
else:
    new_text = current_file.text.replace(args.search, args.replace)
    current_file.text = new_text

current_file.print_window()
